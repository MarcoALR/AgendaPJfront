<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigos - Agenda PJ</title>
  <link rel="stylesheet" href="./src/styles/favoritos.css" />
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo">
        <img src="/src/assets/agendapjlogo.png" alt="Logo Agenda PJ" class="logo-img">
      </div>
      <h2 class="logo">👫 Amigos</h2>
      <nav>
        <ul>
          <li><a href="/CriarContato">Painel 📇</a></li>
          <li><a href="contatos.html">Contatos 👥</a></li>
          <li><a href="favoritos.html">⭐ Favoritos</a></li>
        </ul>
        <ul><br>
          <li><a href="familia.html">👨‍👩‍👧 Família</a></li>
          <li><a href="trabalho.html">💼 Trabalho</a></li>
          <li><a href="outros.html">📂 Outros</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="theme-toggle">
        <span>🌗</span>
        <label class="switch">
          <input type="checkbox" id="theme-checkbox">
          <span class="slider"></span>
        </label>
        <span>🌙</span>
      </div>

      <h2>Contatos - Amigos</h2>
      <br>
      <div class="contacts-container" id="category-container"></div>
    </main>

    <div class="usuario-info">
      <span class="usuario-logado">👤 Usuário</span>
      <button class="botao-topo-direita" id="logout-button">Sair</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("accessToken");

      if (!token) {
        alert("⚠️ Você precisa estar autenticado para acessar esta página.");
        window.location.replace("/");
        return;
      }

      try {
        const response = await fetch("https://apiusuarios-afl5.onrender.com/validate-token", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          throw new Error("Sessão inválida ou expirada");
        }

        console.log("✅ Sessão válida, usuário autenticado");

      } catch (error) {
        console.error("❌ Erro de autenticação:", error);
        localStorage.removeItem("accessToken");
        localStorage.removeItem("usuarioLogado");
        alert("⚠️ Sessão expirada. Por favor, faça o login.");
        window.location.replace("/");
        return;
      }

      const themeToggle = document.getElementById("theme-checkbox");
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme === "dark") {
        document.body.classList.add("dark-theme");
        if (themeToggle) themeToggle.checked = true;
      }

      if (themeToggle) {
        themeToggle.addEventListener("change", () => {
          const isDark = themeToggle.checked;
          document.body.classList.toggle("dark-theme", isDark);
          localStorage.setItem("theme", isDark ? "dark" : "light");
        });
      }

      const logoutBtn = document.getElementById("logout-button");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", function () {
          const confirmLogout = window.confirm("Tem certeza que quer sair da sua conta?");
          if (confirmLogout) {
            localStorage.removeItem("accessToken");
            localStorage.removeItem("usuarioLogado");
            console.log("Logout realizado");
            alert("Você saiu da sua conta.");
            window.location.replace("/");
          }
        });
      }

      const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
      const usuarioLogadoEl = document.querySelector(".usuario-logado");
      if (usuario && usuario.name && usuarioLogadoEl) {
        usuarioLogadoEl.textContent = `👤 ${usuario.name}`;
      }
      const container = document.getElementById("category-container");
      const contatosKey = `agenda-contatos-${usuario.email}`;
      const data = localStorage.getItem(contatosKey);

      if (data) {
        const contacts = JSON.parse(data);
        const filtered = contacts.filter(c => c.category === "Amigos");

        if (filtered.length === 0) {
          container.innerHTML = "<p>Nenhum contato na categoria Amigos ainda.</p>";
          return;
        }

        filtered.forEach(contact => {
          const card = document.createElement("div");
          card.classList.add("contact-card");

          card.innerHTML = `
          <h3>${contact.name}</h3>
          <p>📞 ${contact.phone}</p>
          <p>📧 ${contact.email || "—"}</p>
          <p>📁 Categoria: <strong>${contact.category}</strong></p>
          ${contact.favorite ? "<p>⭐ Favorito</p>" : ""}
        `;
          container.appendChild(card);
        });
      } else {
        container.innerHTML = "<p>Nenhum contato encontrado para este usuário.</p>";
      }
    });
  </script>
</body>

</html>